name: Main workflow
on: [push]
jobs:
  cypress-run:
    runs-on: ubuntu-20.04
    steps:
      - name: 🔀 Checkout
        uses: actions/checkout@v2

      - name: 🧹 Shutdown Ubuntu MySQL (SUDO)
        run: sudo service mysql stop

      - name: 🔐 Create env file
        run: |
          touch .env
          echo SECRET=$(openssl rand -base64 32) >> .env
          echo NEXTAUTH_URL=http://localhost:3000 >> .env
          echo DB_CONNECTION=mysql >> .env
          echo DB_HOST=localhost >> .env
          echo DB_USERNAME=root >> .env
          echo DB_PASSWORD=example >> .env
          echo DB_DATABASE=iwantmymoneyback >> .env
          echo DB_PORT=3306 >> .env
          echo DB_SYNCHRONIZE=true >> .env
          echo DB_LOGGING=false >> .env
          cat .env

      - name: 🐬 Set up MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          host port: 3306
          container port: 3306
          character set server: 'utf8'
          collation server: 'utf8_general_ci'
          mysql version: '8.0'
          mysql database: 'iwantmymoneyback'
          mysql root password: 'example'

      - name: 🧰 Install dependencies
        run: npm ci

      # - name: 📦 Build project
      #   run: npm run build --if-present

      - name: ✒ Run lint
        continue-on-error: true
        run: npm run lint

      - name: 🐛 Cypress run
        uses: cypress-io/github-action@v2
        with:
          spec: cypress/integration/projet-gl/*.js
          # "npm run dev" replace "npm start" for the moment bc build job fails
          start: npm run dev
          # quote the url to be safe against YML parsing surprises
          wait-on: 'http://localhost:3000/'
